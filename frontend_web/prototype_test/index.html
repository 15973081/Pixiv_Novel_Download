<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Pixiv Novel Downloader â€“ Prototype</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 20px;
        }
        h2 {
            margin-top: 28px;
        }
        .block {
            border: 1px solid #ccc;
            padding: 12px;
            margin-bottom: 20px;
        }
        input, select, button {
            padding: 6px;
            margin: 4px 0;
        }
        pre {
            background: #f6f6f6;
            padding: 10px;
            max-height: 300px;
            overflow: auto;
        }
        .status {
            font-weight: bold;
        }
        .ok { color: green; }
        .err { color: red; }
    </style>
</head>
<body>

<h1>ğŸ“– Pixiv Novel Downloader â€“ åŸå‹å‰ç«¯ï¼ˆå¯è°ƒè¯•ï¼‰</h1>

<!-- ================= è¯·æ±‚è°ƒè¯•åŒº ================= -->
<div class="block">
    <h2>ğŸ“¡ è¯·æ±‚è°ƒè¯•</h2>
    <div>Method: <span id="reqMethod"></span></div>
    <div>URL: <span id="reqUrl"></span></div>
    <div>Status: <span id="reqStatus" class="status"></span></div>
    <pre id="reqResult"></pre>
</div>

<!-- ================= å°è¯´æœç´¢ ================= -->
<div class="block">
    <h2>ğŸ” æœç´¢å°è¯´</h2>
    <input id="searchKeyword" placeholder="å…³é”®è¯">
    <input id="searchPage" type="number" value="1" min="1">
    <button onclick="searchNovel()">æœç´¢</button>
</div>

<!-- ================= å•ç¯‡å°è¯´ ================= -->
<div class="block">
    <h2>ğŸ“˜ å•ç¯‡å°è¯´</h2>
    <input id="novelId" placeholder="Novel ID">
    <br>
    <button onclick="getNovelInfo()">ä¿¡æ¯</button>
    <button onclick="getNovelContent()">å†…å®¹</button>
    <button onclick="downloadNovel()">ä¸‹è½½ TXT</button>
</div>

<!-- ================= ç³»åˆ— ================= -->
<div class="block">
    <h2>ğŸ“š å°è¯´ç³»åˆ—</h2>
    <input id="seriesId" placeholder="Series ID">
    <br>
    <button onclick="getSeriesInfo()">ç³»åˆ—ä¿¡æ¯</button>
    <button onclick="getSeriesContent()">ç« èŠ‚ ID</button>
    <br><br>
    <select id="seriesMode">
        <option value="split">splitï¼ˆzipï¼‰</option>
        <option value="merge">mergeï¼ˆtxtï¼‰</option>
    </select>
    <button onclick="downloadSeries()">ä¸‹è½½ç³»åˆ—</button>
</div>

<script>
    const API = "http://127.0.0.1:8000";

    /* ================= æ ¸å¿ƒè¯·æ±‚æ‰§è¡Œå™¨ ================= */
    async function request(method, url, options = {}) {
        document.getElementById("reqMethod").textContent = method;
        document.getElementById("reqUrl").textContent = url;
        document.getElementById("reqStatus").textContent = "pending";
        document.getElementById("reqStatus").className = "status";
        document.getElementById("reqResult").textContent = "";

        try {
            const res = await fetch(url, { method, ...options });
            const ct = res.headers.get("content-type") || "";

            document.getElementById("reqStatus").textContent = res.status;
            document.getElementById("reqStatus").classList.add(res.ok ? "ok" : "err");

            if (ct.includes("application/json")) {
                const data = await res.json();
                document.getElementById("reqResult").textContent =
                    JSON.stringify(data, null, 2);
                return data;
            } else {
                const blob = await res.blob();
                document.getElementById("reqResult").textContent =
                    `[binary response] ${blob.size} bytes`;
                return blob;
            }
        } catch (e) {
            document.getElementById("reqStatus").textContent = "ERROR";
            document.getElementById("reqStatus").classList.add("err");
            document.getElementById("reqResult").textContent = e.toString();
            throw e;
        }
    }

    /* ================= å°è¯´ ================= */
    function searchNovel() {
        const kw = document.getElementById("searchKeyword").value;
        const page = document.getElementById("searchPage").value;
        request(
            "GET",
            `${API}/novel/search?keyword=${encodeURIComponent(kw)}&page=${page}`
        );
    }

    function getNovelInfo() {
        const id = document.getElementById("novelId").value;
        request("GET", `${API}/novel/${id}`);
    }

    function getNovelContent() {
        const id = document.getElementById("novelId").value;
        request("GET", `${API}/novel/${id}/content`);
    }

    function downloadNovel() {
        const id = document.getElementById("novelId").value;
        if (!id) {
            alert("è¯·è¾“å…¥å°è¯´ ID");
            return;
        }

        window.location.href =
            `${API}/novel/${id}/download`;
    }


    /* ================= ç³»åˆ— ================= */
    function getSeriesInfo() {
        const id = document.getElementById("seriesId").value;
        request("GET", `${API}/series/${id}`);
    }

    function getSeriesContent() {
        const id = document.getElementById("seriesId").value;
        request("GET", `${API}/series/${id}/content`);
    }

    async function downloadSeries() {
        const id = document.getElementById("seriesId").value;
        const mode = document.getElementById("seriesMode").value;
        const blob = await request(
            "GET",
            `${API}/series/${id}/download?mode=${mode}`
        );
        const ext = mode === "merge" ? "txt" : "zip";
        saveBlob(blob, `${id}.${ext}`);
    }

    /* ================= ä¸‹è½½å·¥å…· ================= */
    function saveBlob(blob, filename) {
        const a = document.createElement("a");
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>
